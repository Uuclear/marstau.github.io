---
layout: post
title: gitlab
category: 书籍与软件工具
tags: software／tool
keywords: gitlab
description: 
---

## gitlab installation

### for centos-6[More](https://about.gitlab.com/installation/#centos-6?version=ce)

1. Install and configure the necessary dependencies

If you install Postfix to send email please select 'Internet Site' during setup. Instead of using Postfix you can also use Sendmail or configure a custom SMTP server and configure it as an SMTP server.

On Centos 6 and 7, the commands below will also open HTTP and SSH access in the system firewall.

```
sudo yum install curl openssh-server openssh-clients postfix cronie
sudo service postfix start
sudo chkconfig postfix on
sudo lokkit -s http -s ssh
```

2. Add the GitLab package server and install the package

```
curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash
sudo yum install gitlab-ce
```

If you are not comfortable installing the repository through a piped script, you can find the entire script here and select and download the package manually and install using

```
curl -LJO https://packages.gitlab.com/gitlab/gitlab-ce/packages/el/6/gitlab-ce-XXX.rpm/download
rpm -i gitlab-ce-XXX.rpm
```


3. Configure and start GitLab

```
sudo gitlab-ctl reconfigure
```

4. Browse to the hostname and login

On your first visit, you'll be redirected to a password reset screen to provide the password for the initial administrator account. Enter your desired password and you'll be redirected back to the login screen.

The default account's username is root. Provide the password you created earlier and login. After login you can change the username if you wish.

5. configure your ip address

In file `/var/opt/gitlab/gitlab-rails/etc/gitlab.yml` and `/opt/gitlab/embedded/service/gitlab-rails/config/gitlab.yml`

modify

```
  gitlab:
    ## Web server settings (note: host is the FQDN, do not include http://)
    host: localhost
    port: 80
    https: false

```

and 

```
  gitlab:
    host: localhost
    port: 80

```

to your ip address.

6. If you want to open lfs, configure as fowllowing.[More](https://github.com/gitlabhq/gitlabhq/blob/master/doc/workflow/lfs/lfs_administration.md)

Git LFS objects can be large in size. By default, they are stored on the server GitLab is installed on.
There are two configuration options to help GitLab server administrators:
* Enabling/disabling Git LFS support
* Changing the location of LFS object storage

Omnibus packages

In`/etc/gitlab/gitlab.rb`:

```
gitlab_rails['lfs_enabled'] = false

#  Optionally, change the storage path location. Defaults to
#  `#{gitlab_rails['shared_path']}/lfs-objects`. Which evaluates to
#  `/var/opt/gitlab/gitlab-rails/shared/lfs-objects` by default.
gitlab_rails['lfs_storage_path'] = "/mnt/storage/lfs-objects"
Installations from source
```

In`/opt/gitlab/embedded/service/gitlab-rails/config/gitlab.yml`:

```
  lfs:
    enabled: false
    storage_path: /mnt/storage/lfs-objects
```

### for centos-7[More](https://about.gitlab.com/installation/#centos-7?version=ce)

```
sudo yum install -y curl policycoreutils-python openssh-server openssh-clients
sudo systemctl enable sshd
sudo systemctl start sshd
sudo firewall-cmd --permanent --add-service=http
sudo systemctl reload firewalld
```

```
sudo yum install postfix
sudo systemctl enable postfix
sudo systemctl start postfix
```

```
curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash
yum install gitlab-ce-9.4.3* -y --nogpgchec # 安装9.4.3版本的gitlab
```

### 安装问题


#### yum install提示软件包没有签名

```
yum install gitlab-ce-9.4.3* -y --nogpgchec # 加上--nogpgchec
```

#### 提示FirewallD is not running

```
systemctl start firewalld
```
#### lokkit command not found

```
yum -y install lokkit
```

#### 卡在ruby_block[supervise_redis_sleep] action run一直不动[More](https://gitlab.com/gitlab-org/omnibus-gitlab/issues/160#note_24078285)

```
ruby_block[supervise_redis_sleep] action run
```

运行`sudo systemctl restart gitlab-runsvdir`然后再执行`sudo gitlab-ctl reconfigure`

### 完全卸载[More](https://yq.aliyun.com/articles/114619)

```
gitlab-ctl stop #停止gitlab
gitlab-ctl restart #重启gitlab
rpm -e gitlab-ce #卸载gitlab
ps aux | grep gitlab #查看进程
kill -9 18777 #杀掉进程
find / -name gitlab | xargs rm -rf #删除所有包含gitlab的文件
```

## gitlab使用现有的nginx[More](https://blog.csdn.net/peterxiaoq/article/details/73330302)


nginx config:

```
# gitlab socket 文件地址
upstream gitlab {
  # 7.x 版本在此位置
  # server unix:/var/opt/gitlab/gitlab-rails/tmp/sockets/gitlab.socket;
  # 8.0 位置
  server unix://var/opt/gitlab/gitlab-rails/sockets/gitlab.socket;
}

server {
  listen *:80;

  server_name gitlab.liaohuqiu.com;   # 请修改为你的域名

  server_tokens off;     # don't show the version number, a security best practice
  root /opt/gitlab/embedded/service/gitlab-rails/public;

  # Increase this if you want to upload large attachments
  # Or if you want to accept large git objects over http
  client_max_body_size 250m;

  # individual nginx logs for this gitlab vhost
  access_log  /var/log/gitlab/nginx/gitlab_access.log;
  error_log   /var/log/gitlab/nginx/gitlab_error.log;

  location / {
    # serve static files from defined root folder;.
    # @gitlab is a named location for the upstream fallback, see below
    try_files $uri $uri/index.html $uri.html @gitlab;
  }

  # if a file, which is not found in the root folder is requested,
  # then the proxy pass the request to the upsteam (gitlab unicorn)
  location @gitlab {
    # If you use https make sure you disable gzip compression 
    # to be safe against BREACH attack

    proxy_read_timeout 300; # Some requests take more than 30 seconds.
    proxy_connect_timeout 300; # Some requests take more than 30 seconds.
    proxy_redirect     off;

    proxy_set_header   X-Forwarded-Proto $scheme;
    proxy_set_header   Host              $http_host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Frame-Options   SAMEORIGIN;

    proxy_pass http://gitlab;
  }

  # Enable gzip compression as per rails guide: http://guides.rubyonrails.org/asset_pipeline.html#gzip-compression
  # WARNING: If you are using relative urls do remove the block below
  # See config/application.rb under "Relative url support" for the list of
  # other files that need to be changed for relative url support
  location ~ ^/(assets)/  {
    root /opt/gitlab/embedded/service/gitlab-rails/public;
    # gzip_static on; # to serve pre-gzipped version
    expires max;
    add_header Cache-Control public;
  }

  error_page 502 /502.html;
}
```

## 命令

#### 重启nginx

```
gitlab-ctl restart nginx # gitlab-ctl 守护进程启动的 nginx.
cat /opt/gitlab/embedded/service/gitlab-rails/VERSION # 查看gitlab版本号
sudo gitlab-ctl tail postgresql # 检查postgresql运行状态
```

禁用自带nginx

```
vim /etc/gitlab/gitlab.rb

禁用
nginx['enable'] = false
```

重启nginx

```
sudo /usr/local/nginx/sbin/nginx -s reload
sudo gitlab-ctl reconfigure
```

权限配置

访问会报502。原本是 nginx 用户无法访问gitlab用户的 socket 文件，用户权限配置，因人而异。粗暴地:


```
sudo chmod -R o+x /var/opt/gitlab/gitlab-rails
```

## Usage

#### Personal access tokens[More](https://docs.gitlab.com/ce/user/profile/personal_access_tokens.html)

```
In Profile settings -> Access tokens
```

requirements.txt for python

```
-e git+http://username:access_token@ip/project/projectname.git@#egg=services
```

## Error

#### `fatal: parameter inet_interfaces: no local interface found`

Run `systemctl status postfix.service`, send error:`Failed to start Postfix Mail Transport Agent.`

In `/var/log/maillog`, It records `fatal: parameter inet_interfaces: no local interface found`.

Solution:[More](https://blog.csdn.net/CSDNones/article/details/50717934)

In `vim /etc/postfix/main.cf`, replace:

```
inet_interfaces = localhost
```

to

```
inet_interfaces = all
```




## Reference
